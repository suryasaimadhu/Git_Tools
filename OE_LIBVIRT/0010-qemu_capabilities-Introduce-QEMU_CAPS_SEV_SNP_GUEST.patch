From 9d49a35c69a857f78910e116c3211f40f3e6e4bb Mon Sep 17 00:00:00 2001
From: Michal Privoznik <mprivozn@redhat.com>
Date: Wed, 12 Jun 2024 09:04:16 +0200
Subject: [PATCH 10/15] qemu_capabilities: Introduce QEMU_CAPS_SEV_SNP_GUEST
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

commit 1abcba9d4d8566b298168e1f57bce7507a0790b4 upstream

This capability tracks sev-snp-guest object availability.

[Backport Changes]

1. In the file src/qemu/qemu_capabilities.c, within enum VIR_ENUM_IMPL,
added missing members from index 454 to 459 prior to sev-snp-guest to
support sev-snp and to maintain the enum integrity.

2. In the file src/qemu/qemu_capabilities.h, within the enum
virQEMUCapsFlags, member QEMU_CAPS_SEV_SNP_GUEST assigned with index
value 460 to maintain the enum integrity.

3. Changes in tests/qemucapabilitiesdata/caps_9.1.0_x86_64.xml were skipped
because Libvirt 9.10 supports XML files only for QEMU 8.2 and earlier
versions. Since the backport effort focuses on enabling Euler Libvirt
version 9.10 to work with Euler QEMU version 8.2, the XML file changes are
limited to QEMU versions 8.2 and below.

Signed-off-by: Michal Privoznik <mprivozn@redhat.com>
Reviewed-by: Daniel P. Berrang√© <berrange@redhat.com>
Signed-off-by: suryasaimadhu <saimadhu.koyyalaharivenkata@amd.com>
---
 src/qemu/qemu_capabilities.c | 12 ++++++++++++
 src/qemu/qemu_capabilities.h |  3 +++
 2 files changed, 15 insertions(+)

diff --git a/src/qemu/qemu_capabilities.c b/src/qemu/qemu_capabilities.c
index 0f6f55773c22..bf9f76b76ae5 100644
--- a/src/qemu/qemu_capabilities.c
+++ b/src/qemu/qemu_capabilities.c
@@ -700,6 +700,17 @@ VIR_ENUM_IMPL(virQEMUCaps,
               "virtio-blk-vhost-vdpa", /* QEMU_CAPS_DEVICE_VIRTIO_BLK_VHOST_VDPA */
               "smp-clusters", /* QEMU_CAPS_SMP_CLUSTERS */
               "virtio-blk.iothread-mapping", /* QEMU_CAPS_VIRTIO_BLK_IOTHREAD_MAPPING */
+              "virtio-mem-pci.dynamic-memslots", /* QEMU_CAPS_DEVICE_VIRTIO_MEM_PCI_DYNAMIC_MEMSLOTS */
+
+              /* 455 */
+              "blockjob.backing-mask-protocol", /* QEMU_CAPS_BLOCKJOB_BACKING_MASK_PROTOCOL */
+              "display-reload", /* QEMU_CAPS_DISPLAY_RELOAD */
+              "usb-mtp", /* QEMU_CAPS_DEVICE_USB_MTP */
+              "machine.virt.ras", /* QEMU_CAPS_MACHINE_VIRT_RAS */
+              "virtio-sound", /* QEMU_CAPS_DEVICE_VIRTIO_SOUND */
+
+              /* 460 */
+              "sev-snp-guest", /* QEMU_CAPS_SEV_SNP_GUEST */
     );
 
 
@@ -1388,6 +1399,7 @@ struct virQEMUCapsStringFlags virQEMUCapsObjectTypes[] = {
     { "virtio-crypto-device", QEMU_CAPS_DEVICE_VIRTIO_CRYPTO },
     { "cryptodev-backend-lkcf", QEMU_CAPS_OBJECT_CRYPTO_LKCF },
     { "pvpanic-pci", QEMU_CAPS_DEVICE_PANIC_PCI },
+    { "sev-snp-guest", QEMU_CAPS_SEV_SNP_GUEST },
 };
 
 
diff --git a/src/qemu/qemu_capabilities.h b/src/qemu/qemu_capabilities.h
index 9a0de86c066a..5d91ab008f74 100644
--- a/src/qemu/qemu_capabilities.h
+++ b/src/qemu/qemu_capabilities.h
@@ -680,6 +680,9 @@ typedef enum { /* virQEMUCapsFlags grouping marker for syntax-check */
     QEMU_CAPS_SMP_CLUSTERS, /* -smp clusters= */
     QEMU_CAPS_VIRTIO_BLK_IOTHREAD_MAPPING, /* virtio-blk supports per-virtqueue iothread mapping */
 
+    /* 460 */
+    QEMU_CAPS_SEV_SNP_GUEST = 460, /* -object sev-snp-guest */
+
     QEMU_CAPS_LAST /* this must always be the last item */
 } virQEMUCapsFlags;
 
-- 
2.43.0

